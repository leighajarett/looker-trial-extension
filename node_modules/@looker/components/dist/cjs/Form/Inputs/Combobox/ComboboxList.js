"use strict";
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const design_tokens_1 = require("@looker/design-tokens");
const react_1 = __importStar(require("react"));
const styled_components_1 = __importStar(require("styled-components"));
const once_1 = __importDefault(require("lodash/once"));
const throttle_1 = __importDefault(require("lodash/throttle"));
const Popover_1 = require("../../../Popover");
const ComboboxContext_1 = require("./ComboboxContext");
const useBlur_1 = require("./utils/useBlur");
const useKeyDown_1 = require("./utils/useKeyDown");
const state_1 = require("./utils/state");
const ComboboxListInternal = react_1.forwardRef((_a, forwardedRef) => {
    var { persistSelection = false, closeOnSelect = true, windowedOptions = false, isMulti } = _a, props = __rest(_a, ["persistSelection", "closeOnSelect", "windowedOptions", "isMulti"]);
    const context = react_1.useContext(ComboboxContext_1.ComboboxContext);
    const contextMulti = react_1.useContext(ComboboxContext_1.ComboboxMultiContext);
    const contextToUse = isMulti ? contextMulti : context;
    const { persistSelectionPropRef, closeOnSelectPropRef, windowedOptionsPropRef, transition, wrapperElement, isVisible, optionsRef, popoverRef, setListScrollPosition, setListClientRect, } = contextToUse;
    if (persistSelectionPropRef)
        persistSelectionPropRef.current = persistSelection;
    if (closeOnSelectPropRef)
        closeOnSelectPropRef.current = closeOnSelect;
    if (windowedOptionsPropRef)
        windowedOptionsPropRef.current = windowedOptions;
    react_1.useLayoutEffect(() => {
        if (optionsRef)
            optionsRef.current = [];
        return () => {
            if (optionsRef)
                optionsRef.current = [];
        };
    }, [optionsRef, isVisible]);
    const handleKeyDown = useKeyDown_1.useKeyDown();
    const handleBlur = useBlur_1.useBlur();
    const width = wrapperElement
        ? wrapperElement.getBoundingClientRect().width
        : 'auto';
    const content = (react_1.default.createElement(Popover_1.PopoverContent, { width: width, onKeyDown: handleKeyDown, onBlur: handleBlur, ref: popoverRef, p: "none" },
        react_1.default.createElement("ul", Object.assign({}, props, { ref: forwardedRef, role: "listbox", tabIndex: -1, "data-testid": "combobox-list" }))));
    const setOpen = (isOpen) => {
        if (!isOpen) {
            transition && transition(state_1.ComboboxActionType.BLUR);
        }
    };
    const { popover, contentContainer, popperInstanceRef } = Popover_1.usePopover({
        arrow: false,
        content,
        focusTrap: false,
        isOpen: isVisible,
        placement: 'bottom',
        setOpen,
        triggerElement: wrapperElement,
        triggerToggle: false,
    });
    const valueLength = isMulti ? contextMulti.data.options.length : 1;
    react_1.useEffect(() => {
        popperInstanceRef.current && popperInstanceRef.current.update();
    }, [popperInstanceRef, valueLength]);
    react_1.useEffect(() => {
        const setListClientRectOnce = once_1.default((containerElement) => {
            setListClientRect &&
                setListClientRect(containerElement.getBoundingClientRect());
        });
        const scrollListener = throttle_1.default(() => {
            if (contentContainer) {
                setListClientRectOnce(contentContainer);
                setListScrollPosition &&
                    setListScrollPosition(contentContainer.scrollTop);
            }
        }, 50);
        if (contentContainer) {
            contentContainer.addEventListener('scroll', scrollListener);
            scrollListener();
        }
        return () => {
            contentContainer &&
                contentContainer.removeEventListener('scroll', scrollListener);
            setListScrollPosition && setListScrollPosition(0);
            setListClientRect && setListClientRect(undefined);
        };
    }, [contentContainer]);
    return popover || null;
});
ComboboxListInternal.displayName = 'ComboboxListInternal';
const comboboxListStyles = styled_components_1.css `
  ${design_tokens_1.reset}
  ${design_tokens_1.typography}
  ${design_tokens_1.space}
  list-style-type: none;
  margin: 0;
  padding: ${({ isMulti, theme }) => (isMulti ? theme.space.xsmall : 0)} 0;
  max-height: 30rem;
`;
exports.ComboboxList = styled_components_1.default(ComboboxListInternal).attrs({
    isMulti: false,
}).withConfig({ displayName: "ComboboxList", componentId: "sc-b0l5am" }) `
  ${comboboxListStyles}
`;
exports.ComboboxMultiList = styled_components_1.default(ComboboxListInternal).attrs({
    isMulti: true,
}).withConfig({ displayName: "ComboboxMultiList", componentId: "sc-33fdbw" }) `
  ${comboboxListStyles}
`;
exports.ComboboxList.defaultProps = {
    py: 'xsmall',
};
//# sourceMappingURL=ComboboxList.js.map