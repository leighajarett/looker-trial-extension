# Looker Extension SDK

An SDK that may be used by Looker extensions to make API calls or otherwise interact with their host context.

A Looker extension is JavaScript code that code that runs inside of the Looker UI and exposes an interface for custom functionality. (In this setup, the extension itself can be thought of as a client, while Looker can be thought of as a host.) Via this Extension SDK, the extension may request that the Looker host perform various tasks to enhance your extension. This allows the host to take care of complex functionality, including API authentication, so your extension does not need to perform any setup and does not need to deal with any credentials.

Extensions are implemented as a sandboxed `<iframe>` and communication with Looker is accomplished through this SDK. Internally, the SDK will translate function calls into messages passed safely across the iframe boundary. The specific format of those messages is considered private, and this SDK is the only supported interface for interacting with the host from an extension.

[React bindings for extensions](https://github.com/looker-open-source/extension-template-react) are also available, as well as [a template project in React and TypeScript to help you get started](https://github.com/looker-open-source/extension-template-react).

## Installation

Add dependency to your project using yarn or npm

`yarn add @looker/extension-sdk`

or

`npm install @looker/extension-sdk`

## Usage

### Establish connection

The Extension SDK must establish a connection with its host before further functionality will be available.

```ts
import { LookerExtensionSDK, connectExtensionHost } from "@looker/extension-sdk"
import { Looker40SDK } from '@looker/sdk/dist/sdk/4.0/methods'

let extensionSDK
let coreSDK

// Establish connection
connectExtensionHost().then((host) => {
    // This `extensionSDK` can perform extension-specific actions
    extensionSDK = host
    // This `coreSDK` is an automatically credentialed variant of the standard Looker Core SDK for performing API calls
    coreSDK = LookerExtensionSDK.create40Client(extensionSDK)
}).catch((error) => console.error())
```

The following create methods are also available
- `LookerExtensionSDK.createClient(extensionSDK)` creates a Looker31SDK instance.
- `LookerExtensionSDK.create31Client(extensionSDK)` creates a Looker31SDK instance.

#### Connection configuration

`connectExtensionHost()` can also accept a configuration object as an argument.

- `initializedCallback` - (optional) an initialization callback that is called after communicating with the looker host. The callback routine accepts an error message argument that will be populated should an error occur during initialization (for example a looker version issue).
- setInitialRoute - (optional) a callback to set the initial route. The initial route is also available in the `ExtensionSDK lookerHostData` property and as such this callback is likely to be removed in a future release.
- requiredLookerVersion - (optional) specify the required version of the Looker host. If the Looker host does not meet the required version an error message will be passed to the initializedCallback function.

#### Looker host data

Looker host data is made available once the host connection has been established
- ```lookerVersion``` - host Looker version. Test this value if the extension depends on a particular version of Looker.
- ```route``` - if routes are tracked, route is the last active route tracked by the host. On initialization the extension may set its route to this value.

### Update browser window title

```ts
extensionSDK.updateTitle('Change the window title')
```

### Navigation and Links

To navigate the host context to a new page:

```ts
extensionSDK.updateLocation('/dashboards/37')
```

Or to open a new tab:

```ts
extensionSDK.openBrowserWindow('/dashboards/37', '_blank')
```
### Close host popovers

The Looker host may overlay the extension with it's popovers. These will not automatically
close when the extension is active. The extension may request that the Looker host close
any open popovers.

```ts
extensionSDK.closeHostPopovers()
```

### Local storage

Extensions may read/write data from/to the Looker host local storage. Note that the storage is
namespaced to the extension. The extension may not read/write data from other extensions or
the Looker host. Note that the extension localstorage API is asynchronous which is different
from the regular browser localstorage API which is synchronous.

```ts
    // Save to localstorage
    await extensionSDK.localStorageSetItem("data", JSON.stringify(myDataObj))

    // Read from localstorage
    const value = await extensionSDK.localStorageGetItem("data")
    const myDataObj = JSON.parse(value)

    // Remove from localstorage
    await extensionSDK.localStorageRemoveItem("data")

```

### External API

The external API allows the extension to call third party API in the context of the Looker
host. Note that entitlements must be defined for the Extension in order to use the external
API feature. The Extension SDK fetchProxy method is a proxy to the Looker host window fetch API.

```ts
    // Get
    const response: any = await extensionSDK.fetchProxy(`${postsServer}/posts`)
    if (response.ok) {
      // Do something with response.body
    } else {
      // error handling
    }

    // Post
    const response = await extensionSDK.fetchProxy(
      `${postsServer}/posts`,
      {
        method: 'POST',
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(myDataObj)
      if (response.ok) {
        // Continue
      } else {
        // Error handling
      }

```

## Related Projects

- [Looker extension template for React](https://github.com/looker-open-source/extension-template-react)
- [Looker extension SDK for React](https://www.npmjs.com/package/@looker/extension-sdk-react)
- [Looker SDK](https://www.npmjs.com/package/@looker/sdk)


